@page "/board"
@using Chess.Logic
@using Models
@using System.Diagnostics
@using System
@using Microsoft.AspNetCore.Components
@using Chess.Models
@using System.Xml
@using System.Buffers


<div class="container my-3">
    <!-- Status -->
    <div class="alert alert-info text-center">
        @if (game.Winner != null)
        {
            <strong>Spillet er slut! Vinderen er: @(game.Winner == Player.White ? game.Player1.Name :
                            game.Player2.Name)</strong>
        }
        else
        {
            <strong>Tur: @currentPlayer.Name (@currentPlayer.Color)</strong>
        }
    </div>

    <!-- Br�ttet -->
    <div id="chessboard"
        style="display:grid; grid-template-columns: repeat(8, 1fr); width: 1200px; height: 1200px; border: 2px solid black;">
        @foreach (KeyValuePair<string, Cell> kvp in game.Board.BoardCells)
        {
            <div @onclick="() => OnCellClick(kvp.Key)" id="@kvp.Key" style="
                                                        background-color:@(kvp.Value.IsHighlighted ? "lightgreen" : kvp.Value.Color);
                                                        height:@kvp.Value.Height;
                                                        width:@kvp.Value.Width;
                                                        border:@(kvp.Value.IsSelected ? "3px solid lightblue" : "1px solid black");
                                                        display:flex;
                                                        justify-content:center;
                                                        align-items:center;
                                                        font-size:48px;
                                                        position:relative;">

                @if (kvp.Value.Occupant != null)
                {
                    var color = kvp.Value.Occupant.Owner == game.Player1.PlayerEnum ? game.Player1.Color : game.Player2.Color;
                    <span style="color:@color; font-size:4rem; text-shadow:0px 0px 2px gray;">
                        @kvp.Value.Occupant.UnicodeSymbol
                    </span>
                }

                <!-- Feltets koordinat -->
                <div style="position:absolute; top:2px; left:2px; font-size:30px; opacity:0.6;">
                    @kvp.Key
                </div>
            </div>
        }
    </div>

</div>

@code {
    [Parameter, SupplyParameterFromQuery] public string Player1Name { get; set; } = "Player 1";
    [Parameter, SupplyParameterFromQuery] public string Player1Color { get; set; } = "white";
    [Parameter, SupplyParameterFromQuery] public string Player2Name { get; set; } = "Player 2";
    [Parameter, SupplyParameterFromQuery] public string Player2Color { get; set; } = "black";

    Chess.Models.Game game = new Chess.Models.Game();

    private ChessPlayer currentPlayer => game.CurrentTurn == game.Player1.PlayerEnum ? game.Player1 : game.Player2;

    protected override void OnParametersSet()
    {
        game.Player1.Name = Player1Name;
        game.Player1.Color = Player1Color;
        game.Player1.PlayerEnum = Player.White; // sikre kobling

        game.Player2.Name = Player2Name;
        game.Player2.Color = Player2Color;
        game.Player2.PlayerEnum = Player.Black; // sikre kobling
    }

    private void OnCellClick(string cellId)
    {
        // Find den spiller, der har tur
        var currentPlayer = game.CurrentTurn == game.Player1.PlayerEnum ? game.Player1 : game.Player2;

        var cell = game.Board.BoardCells[cellId];

        if (cell.IsHighlighted && game.Board.Selected != null)
        {
            var selectedPiece = game.Board.Selected.Occupant;
            if (selectedPiece != null)
            {
                // Flyt brik
                cell.Occupant = selectedPiece;
                game.Board.Selected.Occupant = null;

                selectedPiece.File = cell.Col;
                selectedPiece.Rank = cell.Row;
                selectedPiece.Moves++; // For tracking moves made

                CheckPassant(selectedPiece, cell);
                QueenSpawnCheck(selectedPiece, cell);

                // Fjern highlight og selection
                game.Board.Selected.IsSelected = false;
                game.Board.Selected = null;
                game.Board.PossibleMoves.ForEach(id => game.Board.BoardCells[id].IsHighlighted = false);
                game.Board.PossibleMoves.Clear();

                game.CheckWinner();
                game.NextTurn();

                StateHasChanged(); // opdater UI
            }
        }
        // Hvis cellen har brik af nuv�rende spiller, v�lg den
        else if (cell.Occupant != null && cell.Occupant.Owner == currentPlayer.PlayerEnum)
        {
            game.Board.SelectField(cellId);
            StateHasChanged(); // opdater selection/highlights
        }
    }

    //If piece type is pawn, it checks cell behind after move to check for passant.
    private void CheckPassant(Piece selectedPiece, Cell cell) // TODO: Decouple game logic from the UI layer
    {
        if (selectedPiece.Type == PieceType.Pawn)
        {
            try
            {
                (int, int) movedTo = ChessBoardUtility.ToCoords([cell.Id])[0];
                Console.WriteLine(movedTo);
                int checkPassant = selectedPiece.Owner == Player.White ? -1 : +1; //Check left is white, and right if black.

                (int, int) passantLocation = (movedTo.Item1, movedTo.Item2 + checkPassant); //Gets the location of the passant
                Cell passantCell = ChessBoardUtility.FindCellFromCoords(passantLocation, game.Board.BoardCells);

                if (passantCell?.Occupant != null && passantCell.Occupant.Type == PieceType.Pawn)
                {
                    passantCell.Occupant = null;
                }
            }
            catch (NullReferenceException ex)
            {
                Console.WriteLine($"NUll reference: {ex.Message}");
            }
            catch (KeyNotFoundException ex){
                Console.WriteLine($"Cell id not found: {ex.Message}");
            }

        }
    }

    private void QueenSpawnCheck(Piece selectedPiece, Cell cell)
    {
        try
        {

            if (selectedPiece.Type == PieceType.Pawn)
            {
                int queenSpawnPos = selectedPiece.Owner == Player.White ? 8 : 1;


                if (cell.Col == queenSpawnPos)
                {
                    selectedPiece.Type = PieceType.Queen;
                }
            }
        }
        catch (NullReferenceException ex)
        {
            Console.WriteLine($"NUll reference: {ex.Message}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Unexpected error {ex.Message}");
            Console.WriteLine(ex.StackTrace);
        }
    }
}